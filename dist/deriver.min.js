function derive(a){if(a instanceof Tree||(a=parseInput(a)),"x"===a.val)return new Tree(1);if(!a.left&&!a.right||TreePattern.eq(a.val,TreePattern.NUM))return new Tree(0);if("+"===a.val||"-"===a.val){var b=new Tree(a.val);return b.l(derive(a.left)),b.r(derive(a.right)),0===b.right.val?b.left:0===b.left.val?b.right:b}if("*"===a.val)return TreePattern.eq(a.left.val,TreePattern.NUM)||TreePattern.eq(a.right.val,TreePattern.NUM)?constantRule(a):productRule(a);if("^"===a.val||"sqrt"===a.val){if("sqrt"===a.val){a.left=a.right.clone();var c=new Tree("/");c.l(1),c.r(2),a.right=c,a.val="^"}if(!TreePattern.eq(a.right,TreePattern.NUM))return exponentialRule(a);if(!TreePattern.eq(a.left,TreePattern.NUM))return powerRule(a)}return"/"===a.val?quotientRule(a):TreePattern.eq(a.val,TreePattern.LOG)?logRule(a):TreePattern.eq(a.val,TreePattern.TRIG)?trigRules(a):void 0}function constantRule(a){var b,c,d=new Tree("*");return TreePattern.eq(a.right.val,TreePattern.NUM)?(c=a.right.val,b=derive(a.left)):TreePattern.eq(a.left.val,TreePattern.NUM)&&(c=a.left.val,b=derive(a.right)),1===b.val?new Tree(c):TreePattern.eq(b.val,TreePattern.NUM)?new Tree(c*b.val):b.left&&TreePattern.eq(b.left.val,TreePattern.NUM)?(b.left.val*=c,b):(d.l(c),d.r(b),d)}function powerRule(a){var b=a.clone(),c=new Tree("*");if(TreePattern.eq(b.right.val,TreePattern.NUM)){var d=b.right.val--;c.l(d),1===b.right.val&&(b=b.left),c.r(b)}else c.l(b.right.clone()),b.right.left.val-=b.right.right.val,c.r(b);return chainRule(c,b.left)}function productRule(a){var b=new Tree("+"),c=new Tree("*"),d=new Tree("*");return c.l(a.left),c.r(derive(a.right)),d.l(a.right),d.r(derive(a.left)),b.l(c),b.r(d),b}function quotientRule(a){var b=new Tree("/"),c=new Tree("-"),d=new Tree("^"),e=a.left,f=a.right,g=derive(e),h=derive(f),i=new Tree("*"),j=new Tree("*");1!==g.val?(i.l(f),i.r(g)):i=f,1!==h.val?(j.l(e),j.r(h)):j=e,c.l(i),c.r(j),TreePattern.eq(i,TreePattern.NUM)&&TreePattern.eq(j,TreePattern.NUM)&&(c=i.val-j.val);var k=new Tree("*");if(k.l(TreePattern.ANY),k.r(0),c.left.equals(k)||c.left.equals(k["switch"]())){var l=new Tree("*");l.l(-1),l.r(c.right),c=1===c.right.val?new Tree(-1):l}return c.right&&(c.right.equals(k)||c.right.equals(k["switch"]()))&&(c=c.left),d.l(f),d.r(2),b.l(c),b.r(d),b}function chainRule(a,b){if(b.right){var c=new Tree("*"),d=derive(b);if("1"!=d.val)return c.l(a),c.r(d),c}return a}function trigRules(a){var b=(a.clone(),{sin:parseInput("cos@@@"),cos:parseInput("-1*sin@@@"),tan:parseInput("(sec@@@)^2"),csc:parseInput("-1*csc@@@*cot@@@"),sec:parseInput("sec@@@*tan@@@"),cot:parseInput("-1*(csc@@@)^2"),arcsin:parseInput("1/((1-@@@^2)^(1/2))"),arccos:parseInput("-1/((1-@@@^2)^(1/2))"),arctan:parseInput("1/(1+(@@@^2))"),arccsc:parseInput("-1/(abs(@@@)*(@@@^2-1))"),arcsec:parseInput("1/(abs(@@@)*(@@@^2-1))"),arccot:parseInput("-1/(1+@@@^2)")});if(b[a.val]){var c=b[a.val].clone();return c.replace(TreePattern.MARKER,a.right),chainRule(c,a.right)}}function logRule(a){var b=new Tree("/");return TreePattern.eq(a.right,TreePattern.NUM)?new Tree(0):(b.l(derive(a.right)),b.r(a.right),b)}function exponentialRule(a){var b=new Tree("*"),c=new Tree("ln");return b.l(a.clone()),c.r(a.left),b.r(c),"e"===a.left.val&&(b=a.clone()),chainRule(b,a.right)}function replaceNegatives(a){for(var b=0;b<a.length;b++)"-"===a.charAt(b)&&(0===b||"+*^/-(".indexOf(a.charAt(b-1))>-1)&&(a=a.replaceAt(b,"~"));return a}function parseParens(a){var b=a.findChar("("),c=a.findChar(")"),d=[];if(b.length!==c.length)throw"Mismatched Parentheses!";for(var e=b.length-1;e>=0;e--){for(var f=e;f>=0&&b[e]<c[f];)f--;d.push([b.pop(),c.splice(f+1,1)[0]])}return d.reverse()}function cleanInput(a){function b(a,b){return a-b}function c(a,b){return Math.min.apply(Math,TreePattern.checkParens.map(function(c){return a+b.findChar(c)[0]||b.length+a}))}a=replaceNegatives(a.removeSpaces());var d=[],e=[];Object.keys(TreePattern.__FUNCTIONS).map(function(b){e=e.concat(a.findChar(b).map(function(a){return a+b.length}))}),e.sort(b);for(var f=e.length-1;f>=0;f--){var g=e[f],h=c(g,a.substring(e[f]));"("!==a[g]&&(a=a.splice(g,"("),a=a.splice(h+1,")"))}TreePattern.checkMultiply.map(function(b){d=d.concat(a.findChar(b))}),d.sort(b);for(var i=d.length-1;i>=0;i--){var j=d[i],k=a[j-1];(!isNaN(k)||")x".indexOf(k)>-1)&&(a=a.splice(j,"*"))}for(var l=a.findChar("log"),m=l.length-1;m>=0;m--){var n,o=l[m],p=parseParens(a),q=a.indexOf(",",o),r=a.substring(o+4,q),s=a.substring(q+1,a.indexOf(")",q));for(var t in p)if(p[t][0]===o+3){n=p[t][1];break}s=a.substring(q+1,n);var u="ln("+s+")/ln("+r+")";a=a.cut(o,n).splice(o,u)}return a}function parseInput(a){if(""===a)return!1;a=cleanInput(a);var b=parseParens(a),c=a;b[0]&&0===b[0][0]&&b[0][1]===a.length-1&&(c=a=a.substring(1,a.length-1),b.shift(),b=parseParens(a));for(var d in b){var e=b[d][0],f=b[d][1];a=a.substring(0,e)+Array(f-e+2).join("_")+a.substring(f+1)}for(var g={},h=a.length-1;h>=0;h--)for(var i in TreePattern.OPS)a.substring(h,h+i.length)===i&&(g[i]=h);var j,k;for(var l in TreePattern.OPS)if(g[l]>=0){j=g[l],k=a.substring(j,j+l.length);break}if(void 0===j)return new Tree(3===a.length&&rules[a]?TreePattern[rules[a]]:a.replace(/~/,"-"));var m=new Tree(k);return m.left=parseInput(c.substring(0,j)),m.right=parseInput(c.substring(j+k.length)),m}function simplify(a){var b=[parseInput("###*(###/$$$)")];for(var c in b)if(a.equals(b[c]))return fns[c](a)}function Tree(a){this.val=isNaN(a)?a:Number(a),this.left=!1,this.right=!1}function treePatternRule(a){this.rule=a}function unparse(a){if(!a.left&&!a.right)return a.val;var b=unparse(a.right),c=unparse(a.left),d=a.val;return TreePattern.OPS[a.val]>TreePattern.OPS[a.right.val]&&(b="("+unparse(a.right)+")"),TreePattern.OPS[a.val]>TreePattern.OPS[a.left.val]&&(c="("+unparse(a.left)+")"),"*"===a.val&&"string"==typeof b&&TreePattern.checkMultiply.join("|").indexOf(b[0])>-1&&(d=""),(c||"")+d+b}var fns=[function(a){var b=new Tree("/");return b.l(a.left.val*a.right.left.val),b.r(a.right),b}];String.prototype.splice=function(a,b){return this.slice(0,a)+b+this.slice(a)},String.prototype.cut=function(a,b){return this.substring(0,a)+this.substring(b+1)},String.prototype.replaceAt=function(a,b){return this.substring(0,a)+b+this.substring(a+b.length)},String.prototype.findChar=function(a){for(var b=[],c=0;c<this.length;c++)this.substring(c,c+a.length)===a&&b.push(c);return b},String.prototype.removeSpaces=function(){return this.trim().replace(/\s+/g,"")},Tree.prototype.getDir=function(a){return a=""+a,a=parseInt(a)>=1||"r"===a.toLowerCase()||"right"===a.toLowerCase()?"right":"left"},Tree.prototype.get=function(a,b){a=this.getDir(a);for(var c=this,d=1;b>d;d++)c=c[a];return c},Tree.prototype.add=function(a,b){if(0===b||b){a=this.getDir(a);for(var c=this;c[a];)c=c[a];b instanceof Tree?c[a]=b:c[a]=new Tree(b)}},Tree.prototype.r=function(a){this.add(1,a)},Tree.prototype.l=function(a){this.add(-1,a)},Tree.prototype.equals=function(a){if(!a||!TreePattern.eq(this.val,a.val))return!1;var b,c;return b=c=!0,this.left&&a.left&&(b=a.left.equals(this.left)),this.right&&a.right&&(c=a.right.equals(this.right)),b&&c},Tree.prototype.clone=function(){var a=new Tree(this.val),b=this.left,c=this.right;return b&&(a.left=b.clone()),c&&(a.right=c.clone()),a},Tree.prototype["switch"]=function(){var a=this.right;return this.right=this.left,this.left=a,this},Tree.prototype.contains=function(a){var b,c;return b=c=!1,a instanceof Tree&&this.equals(a)||TreePattern.eq(this.val,a)?!0:(this.left&&(b=this.left.contains(a)),this.right&&(c=this.right.contains(a)),b||c)},Tree.prototype.replace=function(a,b){if(TreePattern.eq(this.val,a)){if(b instanceof Tree)return this.val=b.val,this.l(b.left),void this.r(b.right);this.val=b}this.left&&this.left.replace(a,b),this.right&&this.right.replace(a,b)},Tree.prototype.toString=function(a){a||(a=2);var b=Array(a+1).join(".")+this.left.toString(a+2),c=Array(a+1).join(".")+this.right.toString(a+2);return this.left||(b=""),this.right||(c=""),"["+this.val+"]\n"+b+c},Tree.prototype.toFlatString=function(){var a=this.left?this.left.toFlatString():"",b=this.right?this.right.toFlatString():"";return a+""+this.val+b};var TreePattern={};treePatternRule.prototype.toString=function(){return this.rule};var rules={$$$:"ANY","###":"NUM","&&&":"OP",">>>":"TRIG","@@@":"MARKER",",,,":"LOG"};for(var p in rules)TreePattern[rules[p]]=new treePatternRule(p);var _defaults={"###":1,"&&&":"+",">>>":"sin","@@@":"@@@",",,,":"ln"};TreePattern.__OPS={"+":1,"-":1,"*":2,"/":2,"^":3},TreePattern.__FUNCTIONS={arcsin:4,arccos:4,arctan:4,arccsc:4,arcsec:4,arccot:4,sin:5,cos:5,tan:5,csc:5,sec:5,cot:5,ln:6,log:6,abs:7,sqrt:7},TreePattern.OPS={};for(var o in TreePattern.__OPS)TreePattern.OPS[o]=TreePattern.__OPS[o];for(var o in TreePattern.__FUNCTIONS)TreePattern.OPS[o]=TreePattern.__FUNCTIONS[o];TreePattern.checkMultiply=["(","x"].concat(Object.keys(TreePattern.__FUNCTIONS)),TreePattern.checkParens=[")"].concat(Object.keys(TreePattern.__FUNCTIONS)).concat(Object.keys(TreePattern.__OPS)),TreePattern.fns={"###":function(a){return a instanceof Tree?!isNaN(a.val)||!isNaN(a.left.val)&&!isNaN(a.right.val):!isNaN(a)},"&&&":function(a){return a&&"+-/*^".indexOf(a)>-1},">>>":function(a){return a&&"sin|cos|tan|csc|sec|cot|arcsin|arccos|arctan|arccsc|arcsec|arccot".indexOf(a)>-1},"@@@":function(a){return"@@@"===a},",,,":function(a){return a&&"ln|log".indexOf(a)>-1}},TreePattern.eq=function(a,b){if(b==TreePattern.ANY||a==TreePattern.ANY)return!0;if(a instanceof treePatternRule){var c=b;b=a,a=c}return a instanceof treePatternRule&&(_defaults[a]?a=_defaults[a]:console.log("No "+a)),this.fns[b.rule]?this.fns[b.rule](a):(a instanceof Tree&&(a=a.val),a==b)};